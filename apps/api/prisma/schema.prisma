generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// === Enums ===

enum FulfillmentType {
  pickup
  dine_in
  delivery
}

enum Channel {
  web
  in_store
  ubereats
}

enum DeliveryType {
  STANDARD
  PRIORITY
}

enum DeliveryProvider {
  DOORDASH
  UBER
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum LoyaltyEntryType {
  REDEEM_ON_ORDER
  EARN_ON_PURCHASE
  REFERRAL_BONUS
  REFUND_REVERSE_EARN
  REFUND_RETURN_REDEEM
  REFUND_REVERSE_REFERRAL
  TOPUP_PURCHASED
  ADJUSTMENT_MANUAL

  AMEND_RETURN_REDEEM
  AMEND_EARN_ADJUST
  AMEND_REFERRAL_ADJUST
}

enum PhoneVerificationStatus {
  PENDING
  VERIFIED
  CONSUMED
}

enum UserRole {
  CUSTOMER
  STAFF
  ADMIN
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum TwoFactorMethod {
  OFF
  SMS
}

enum PosDeviceStatus {
  ACTIVE
  DISABLED
}

enum Weekday {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

enum SpecialPricingMode {
  OVERRIDE_PRICE
  DISCOUNT_DELTA
  DISCOUNT_PERCENT
}

// === Models ===

model User {
  id                    String    @id @default(uuid()) @db.Uuid
  userStableId          String    @unique @default(cuid())
  email                 String?   @unique
  emailVerifiedAt       DateTime?
  phone                 String?   @unique
  phoneVerifiedAt       DateTime?
  name                  String?
  role                  UserRole  @default(CUSTOMER)
  status                UserStatus @default(ACTIVE)
  passwordHash          String?
  passwordChangedAt     DateTime?
  twoFactorEnabledAt    DateTime?
  twoFactorMethod       TwoFactorMethod @default(OFF)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  marketingEmailOptIn   Boolean   @default(false)
  marketingEmailOptInAt DateTime?
  birthdayDay           Int?
  birthdayMonth         Int?
  referredByUserId      String?
  googleSub             String?       @unique
  addresses             UserAddress[]
  invitesSent           UserInvite[]  @relation("InvitesSent")
  sessions              UserSession[]
  trustedDevices        TrustedDevice[]
  passwordResetTokens   PasswordResetToken[]
  twoFactorChallenges   TwoFactorChallenge[]

  @@index([referredByUserId])
}

model UserSession {
  id           String   @id @default(uuid()) @db.Uuid
  sessionId    String   @unique
  userId       String   @db.Uuid
  expiresAt    DateTime
  deviceInfo   String?
  mfaVerifiedAt DateTime?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model TwoFactorChallenge {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @db.Uuid
  purpose      String
  codeHash     String
  expiresAt    DateTime
  attempts     Int      @default(0)
  maxAttempts  Int      @default(5)
  consumedAt   DateTime?
  ip           String?
  userAgent    String?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, purpose, expiresAt])
}

model TrustedDevice {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  tokenHash   String   @unique
  label       String?
  createdAt   DateTime @default(now())
  lastSeenAt  DateTime?
  expiresAt   DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model PosDevice {
  id                String          @id @default(uuid()) @db.Uuid
  deviceStableId    String          @unique @default(cuid())
  storeId           String          @db.Uuid
  name              String?
  status            PosDeviceStatus @default(ACTIVE)
  deviceKeyHash     String
  meta              Json?
  enrolledAt        DateTime        @default(now())
  lastSeenAt        DateTime?
  enrollmentKeyHash String          @unique

  @@index([storeId])
}

model UserInvite {
  id              String    @id @default(uuid()) @db.Uuid
  inviteStableId  String    @unique @default(cuid())
  email           String
  role            UserRole
  tokenHash       String    @unique
  expiresAt       DateTime
  usedAt          DateTime?
  invitedByUserId String    @db.Uuid
  createdAt       DateTime  @default(now())
  revokedAt       DateTime?
  sentCount       Int       @default(0)
  lastSentAt      DateTime?
  invitedBy       User      @relation("InvitesSent", fields: [invitedByUserId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([invitedByUserId])
}

model UserAddress {
  id              String   @id @default(uuid()) @db.Uuid
  addressStableId String   @unique @default(cuid())
  userId          String   @db.Uuid
  label           String
  receiver        String
  phone           String?
  addressLine1    String
  addressLine2    String?
  city            String
  province        String
  postalCode      String
  isDefault       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
}

model Order {
  id                         String            @id @default(uuid()) @db.Uuid
  channel                    Channel           @default(web)
  fulfillmentType            FulfillmentType   @default(pickup)
  userId                     String?
  clientRequestId            String?           @unique
  status                     OrderStatus       @default(pending)
  createdAt                  DateTime          @default(now())
  subtotalCents              Int               @default(0)
  taxCents                   Int               @default(0)
  totalCents                 Int               @default(0)
  pickupCode                 String?
  deliveryType               DeliveryType?
  deliveryProvider           DeliveryProvider?
  deliveryEtaMinMinutes      Int?
  deliveryEtaMaxMinutes      Int?
  externalDeliveryId         String?
  deliveryFeeCents      Int @default(0) // 顾客运费
  deliveryCostCents     Int @default(0)      // 第三方成本
  deliverySubsidyCents  Int @default(0) // max(0, cost - fee)
  loyaltyRedeemCents         Int               @default(0)
  subtotalAfterDiscountCents Int               @default(0)
  couponCodeSnapshot         String?
  couponDiscountCents        Int               @default(0)
  couponExpiresAt            DateTime?
  couponId                   String?           @db.Uuid
  couponMinSpendCents        Int?
  couponTitleSnapshot        String?
  contactName                String?
  contactPhone               String?
  orderStableId              String            @unique @default(cuid())
  rebillGroupId              String?
  paidAt                     DateTime
  paymentMethod              PaymentMethod
  amendments                 OrderAmendment[]
  items                      OrderItem[]

  @@index([createdAt])
  @@index([contactPhone, createdAt])
  @@index([rebillGroupId])
}

model Coupon {
  id            String    @id @default(uuid()) @db.Uuid
  couponStableId String @unique @default(cuid())
  userId        String
  code          String
  title         String
  discountCents Int
  minSpendCents Int?
  expiresAt     DateTime?
  issuedAt      DateTime  @default(now())
  usedAt        DateTime?
  orderId       String?   @db.Uuid
  source        String?
  campaign      String?

  @@index([userId, expiresAt])
}

model OrderItem {
  qty             Int
  unitPriceCents  Int?
  baseUnitPriceCents Int?
  optionsUnitPriceCents Int?
  isDailySpecialApplied Boolean @default(false)
  dailySpecialStableId String?
  optionsJson     Json?
  id              String  @id @default(uuid()) @db.Uuid
  orderId         String  @db.Uuid
  displayName     String?
  nameEn          String?
  nameZh          String?
  productStableId String
  order           Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model OrderAmendment {
  id                    String               @id @default(uuid()) @db.Uuid
  amendmentStableId     String               @unique @default(cuid())
  orderId               String               @db.Uuid
  type                  OrderAmendmentType
  paymentMethod         PaymentMethod?
  reason                String
  deltaCents            Int                  @default(0)
  refundCents           Int                  @default(0)
  additionalChargeCents Int                  @default(0)
  rebillGroupId         String?
  summaryJson           Json?
  earnAdjustMicro       BigInt               @default(0)
  redeemReturnCents     Int                  @default(0)
  redeemReturnMicro     BigInt               @default(0)
  referralAdjustMicro   BigInt               @default(0)
  order                 Order                @relation(fields: [orderId], references: [id], onDelete: Cascade)
  items                 OrderAmendmentItem[]

  @@index([orderId])
}

model OrderAmendmentItem {
  id              String                   @id @default(uuid()) @db.Uuid
  amendmentId     String                   @db.Uuid
  action          OrderAmendmentItemAction
  productStableId String
  displayName     String?
  nameEn          String?
  nameZh          String?
  qty             Int
  unitPriceCents  Int?
  optionsJson     Json?
  amendment       OrderAmendment           @relation(fields: [amendmentId], references: [id], onDelete: Cascade)

  @@index([amendmentId])
}

model LoyaltyAccount {
  userId             String          @unique
  pointsMicro        BigInt
  tier               LoyaltyTier     @default(BRONZE)
  createdAt          DateTime        @default(now())
  id                 String          @id @default(uuid()) @db.Uuid
  lifetimeSpendCents Int             @default(0)
  ledger             LoyaltyLedger[]

  @@index([userId])
}

model LoyaltyLedger {
  type              LoyaltyEntryType
  deltaMicro        BigInt
  balanceAfterMicro BigInt
  note              String?
  createdAt         DateTime         @default(now())
  id                String           @id @default(uuid()) @db.Uuid
  ledgerStableId    String           @unique @default(cuid())
  accountId         String           @db.Uuid
  orderId           String?          @db.Uuid
  sourceKey         String           @default("ORDER")
  idempotencyKey    String?          @unique
  account           LoyaltyAccount   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([orderId, type, sourceKey])
  @@index([accountId, createdAt])
  @@index([orderId])
}

model CheckoutIntent {
  referenceId       String   @unique
  checkoutSessionId String?  @unique
  amountCents       Int
  currency          String
  locale            String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  expiresAt         DateTime?
  metadataJson      Json
  orderId           String?  @db.Uuid
  result            String?
  status            String   @default("pending")
  processedAt       DateTime?
  id                String   @id @default(uuid()) @db.Uuid

  @@index([referenceId, createdAt])
}

model PhoneVerification {
  id            String                  @id @default(uuid()) @db.Uuid
  phone         String
  code          String
  status        PhoneVerificationStatus @default(PENDING)
  expiresAt     DateTime
  createdAt     DateTime                @default(now())
  verifiedAt    DateTime?
  consumedAt    DateTime?
  attempts      Int                     @default(0)
  lastAttemptAt DateTime?
  purpose       String                  @default("generic")
  used          Boolean                 @default(false)
  token         String?                 @unique

  @@index([phone, purpose, used, createdAt])
}

model BusinessConfig {
  id                   Int      @id @default(1)
  storeName            String?
  timezone             String   @default("America/Toronto")
  isTemporarilyClosed  Boolean  @default(false)
  temporaryCloseReason String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  deliveryBaseFeeCents Int      @default(600)
  priorityPerKmCents   Int      @default(100)
  salesTaxRate         Float    @default(0.13)
}

model BusinessHour {
  id           Int      @id @default(autoincrement())
  weekday      Int      @unique
  openMinutes  Int?
  closeMinutes Int?
  isClosed     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Holiday {
  id           Int      @id @default(autoincrement())
  date         DateTime
  name         String?
  isClosed     Boolean  @default(true)
  openMinutes  Int?
  closeMinutes Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model MenuCategory {
  id        String     @id @default(uuid())
  sortOrder Int        @default(0)
  nameEn    String
  nameZh    String?
  isActive  Boolean    @default(true)
  stableId  String     @unique @default(cuid())
  deletedAt DateTime?
  items     MenuItem[]

  @@index([sortOrder])
  @@index([deletedAt])
}

model MenuItem {
  id                   String                @id @default(uuid())
  categoryId           String
  stableId             String                @unique @default(cuid())
  nameEn               String
  nameZh               String?
  basePriceCents       Int
  isAvailable          Boolean               @default(true)
  isVisible            Boolean               @default(true)
  tempUnavailableUntil DateTime?
  sortOrder            Int                   @default(0)
  imageUrl             String?
  ingredientsEn        String?
  ingredientsZh        String?
  deletedAt            DateTime?
  category             MenuCategory          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  optionGroups         MenuItemOptionGroup[]
  dailySpecials        MenuDailySpecial[]    @relation("MenuItemDailySpecials")

  @@index([categoryId, sortOrder])
  @@index([deletedAt])
}

model MenuDailySpecial {
  id                 Int      @id @default(autoincrement())
  stableId           String   @unique @default(cuid())
  weekday            Int
  itemStableId       String
  item               MenuItem @relation("MenuItemDailySpecials", fields: [itemStableId], references: [stableId])
  pricingMode        SpecialPricingMode
  overridePriceCents Int?
  discountDeltaCents Int?
  discountPercent    Int?
  startDate          DateTime?
  endDate            DateTime?
  startMinutes       Int?
  endMinutes         Int?
  disallowCoupons    Boolean  @default(true)
  isEnabled          Boolean  @default(true)
  sortOrder          Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  deletedAt          DateTime?

  @@index([weekday, isEnabled, deletedAt])
  @@index([itemStableId])
}

model MenuOptionGroupTemplate {
  id                   String                     @id @default(uuid())
  nameEn               String
  nameZh               String?
  defaultMinSelect     Int                        @default(0)
  defaultMaxSelect     Int?                       @default(1)
  isAvailable          Boolean                    @default(true)
  tempUnavailableUntil DateTime?
  sortOrder            Int                        @default(0)
  stableId             String                     @unique @default(cuid())
  deletedAt            DateTime?
  itemLinks            MenuItemOptionGroup[]
  options              MenuOptionTemplateChoice[]

  @@index([sortOrder])
  @@index([deletedAt])
}

model MenuOptionTemplateChoice {
  id                   String                  @id @default(uuid())
  templateGroupId      String
  nameEn               String
  nameZh               String?
  priceDeltaCents      Int                     @default(0)
  isAvailable          Boolean                 @default(true)
  tempUnavailableUntil DateTime?
  sortOrder            Int                     @default(0)
  stableId             String                  @unique @default(cuid())
  deletedAt            DateTime?
  templateGroup        MenuOptionGroupTemplate @relation(fields: [templateGroupId], references: [id], onDelete: Cascade)

  @@index([templateGroupId, sortOrder])
  @@index([deletedAt])
}

model MenuItemOptionGroup {
  id              String                  @id @default(uuid())
  itemId          String
  templateGroupId String
  minSelect       Int                     @default(0)
  maxSelect       Int?
  sortOrder       Int                     @default(0)
  isEnabled       Boolean                 @default(true)
  item            MenuItem                @relation(fields: [itemId], references: [id], onDelete: Cascade)
  templateGroup   MenuOptionGroupTemplate @relation(fields: [templateGroupId], references: [id], onDelete: Cascade)

  @@unique([itemId, templateGroupId])
  @@index([itemId, sortOrder])
}

enum OrderStatus {
  pending
  paid
  making
  ready
  completed
  refunded
}

enum OrderAmendmentType {
  RETENDER
  VOID_ITEM
  SWAP_ITEM
  ADDITIONAL_CHARGE
}

enum PaymentMethod {
  CASH
  CARD
  WECHAT_ALIPAY
}

enum OrderAmendmentItemAction {
  VOID
  ADD
}
