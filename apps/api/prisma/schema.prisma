//Users/apple/sanqinMVP/apps/api/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// === Enums ===
enum OrderStatus {
  pending
  paid
  making
  ready
  completed
  refunded
}

enum FulfillmentType {
  pickup
  dine_in
  delivery
}

enum Channel {
  web
  in_store
  ubereats
}

enum DeliveryType {
  STANDARD
  PRIORITY
}

enum DeliveryProvider {
  DOORDASH
  UBER
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum LoyaltyEntryType {
  EARN_ON_PURCHASE      // 支付后赚取
  REDEEM_ON_ORDER       // 下单时抵扣
  REFUND_REVERSE_EARN   // 退款时冲回赚取
  REFUND_RETURN_REDEEM  // 退款时退回抵扣

  // ⭐ 新增：用于积分=储值统一记账
  TOPUP_PURCHASED       // 储值/充值时入账的积分（包含本金部分）
  ADJUSTMENT_MANUAL     // 人工调整（活动奖励、补偿、修正等）
  // ⭐ 新增：推荐奖励 & 退款冲销
  REFERRAL_BONUS          // 推荐人因被推荐人消费获得的积分
  REFUND_REVERSE_REFERRAL // 退款时冲回推荐奖励
}
enum PhoneVerificationStatus {
  PENDING   // 已发送，等待用户输入验证码
  VERIFIED  // 验证通过
  CONSUMED  // 已经消费 / 失效（可选状态，方便以后扩展）
}
enum UserRole {
  CUSTOMER
  ADMIN
}
enum Weekday {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

// === Models ===

// ⭐ 新增：用户表
// id 我们用字符串，直接和 next-auth 的 userId 对齐（例如 "google:xxxxx"）
// 不强制 UUID，这样不用改你现有的 token 生成逻辑。
model User {
  id        String   @id         // 例如: "google:1234567890"
  email     String?  @unique
  phone      String?   @unique
  phoneVerifiedAt DateTime?
  name      String?
  role      UserRole @default(CUSTOMER)  // 新增：角色
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  marketingEmailOptIn   Boolean  @default(false)
  marketingEmailOptInAt DateTime?
  // ⭐ 新增：推荐关系，仅在注册时写入一次
  referredByUserId String?  // = 推荐人的 userId（User.id）

  // ⭐ 新增：生日（月/日），用于生日优惠券，仅能设置一次
  birthdayMonth    Int?     // 1-12
  birthdayDay      Int?     // 1-31（代码中再做校验）

  // 目前不加外键关系，继续用 userId 字符串“软关联” Order / LoyaltyAccount，
  // 方便迁移，不会因为老数据导致外键失败。以后需要可以再加关系字段。
  @@index([referredByUserId])
}

// === 订单相关 ===
model Order {
  id              String          @id @default(uuid()) @db.Uuid
  userId          String?
  clientRequestId String?         @unique
  channel         Channel         @default(web)
  fulfillmentType FulfillmentType @default(pickup)
  status          OrderStatus     @default(pending)
  subtotalCents   Int             @default(0)
  taxCents        Int             @default(0)
  totalCents      Int             @default(0)
  pickupCode      String?

  contactName     String?
  contactPhone    String?

  deliveryType           DeliveryType?
  deliveryProvider       DeliveryProvider?
  deliveryFeeCents       Int?
  deliveryCostCents      Int?
  deliveryEtaMinMinutes  Int?
  deliveryEtaMaxMinutes  Int?
  externalDeliveryId     String?
  loyaltyRedeemCents       Int      @default(0)
  subtotalAfterDiscountCents Int    @default(0)
  couponId             String?        @db.Uuid
  couponDiscountCents  Int            @default(0)
  couponCodeSnapshot   String?
  couponTitleSnapshot  String?
  couponMinSpendCents  Int?
  couponExpiresAt      DateTime?

  createdAt       DateTime        @default(now())

  items OrderItem[]

  @@index([createdAt])
  @@index([contactPhone, createdAt])
}

model Coupon {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String
  code           String
  title          String
  discountCents  Int
  minSpendCents  Int?
  expiresAt      DateTime?
  issuedAt       DateTime @default(now())
  usedAt         DateTime?
  orderId        String?  @db.Uuid
  source         String?
  campaign       String?

  @@index([userId, expiresAt])
}

model OrderItem {
  id             String @id @default(uuid()) @db.Uuid
  orderId        String @db.Uuid
  productId      String
  displayName    String?   // 下单时用户看到的名字（跟当前界面 locale 一致）
  nameEn         String?   // 标准英文名
  nameZh         String?   // 标准中文名
  qty            Int
  unitPriceCents Int?
  optionsJson    Json?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

// === 会员积分相关 ===
model LoyaltyAccount {
  id          String      @id @default(uuid()) @db.Uuid
  userId      String      @unique
  pointsMicro BigInt      @db.BigInt
  tier        LoyaltyTier @default(BRONZE)
  createdAt   DateTime    @default(now())

  // ⭐ 新增：累计实际消费（单位：分）
  // 包含：订单实际支付的商品金额（不含积分抵扣） + 储值金额（因为你决定不退款）
  lifetimeSpendCents Int @default(0)

  ledger LoyaltyLedger[]

  @@index([userId])
}

model LoyaltyLedger {
  id                String           @id @default(uuid()) @db.Uuid
  accountId         String           @db.Uuid
  orderId           String?          @db.Uuid
  type              LoyaltyEntryType
  deltaMicro        BigInt           @db.BigInt
  balanceAfterMicro BigInt           @db.BigInt
  note              String?
  createdAt         DateTime         @default(now())

  account LoyaltyAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([orderId, type])
  @@index([accountId, createdAt])
}

model CheckoutIntent {
  id                String   @id @default(uuid()) @db.Uuid
  referenceId       String   @unique
  checkoutSessionId String?  @unique
  amountCents       Int
  currency          String
  locale            String?
  status            String   @default("pending")
  result            String?
  orderId           String?  @db.Uuid
  metadataJson      Json
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([referenceId, createdAt])
}

model PhoneVerification {
  id        String                 @id @default(uuid()) @db.Uuid
  phone     String                 // 经过 normalize 处理后的手机号（去掉空格等）
  code      String                 // 6 位数字验证码（MVP 先明文存）
  status    PhoneVerificationStatus @default(PENDING)

  // 有效期（例如发送后 10 分钟）
  expiresAt DateTime
  createdAt DateTime                @default(now())
  verifiedAt DateTime?
  consumedAt DateTime?
  purpose   String   @default("generic")
  used      Boolean  @default(false)

  // 可选：记录错误尝试次数
  attempts      Int       @default(0)
  lastAttemptAt DateTime?

  @@index([phone, purpose, used, createdAt])
}

model BusinessConfig {
  id                 Int      @id @default(1)      // 单门店可固定为 1
  storeName          String? 
  timezone           String   @default("America/Toronto")
  isTemporarilyClosed Boolean @default(false)      // 手动一键“暂停接单”
  temporaryCloseReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BusinessHour {
  id           Int      @id @default(autoincrement())
  weekday      Int      @unique       // 0=Sunday ... 6=Saturday，保证一天一条
  openMinutes  Int?                   // 开门时间，可以为 null
  closeMinutes Int?                   // 打烊时间，可以为 null
  isClosed     Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Holiday {
  id           Int      @id @default(autoincrement())
  date         DateTime // 只用到日期，可统一当 local midnight 存
  name         String?
  isClosed     Boolean  @default(true)
  openMinutes  Int?
  closeMinutes Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MenuCategory {
  id        String      @id @default(cuid())
  sortOrder Int         @default(0)
  nameEn    String
  nameZh    String?
  isActive  Boolean     @default(true)

  items     MenuItem[]
}

model MenuItem {
  id         String       @id @default(cuid())
  categoryId String
  category   MenuCategory @relation(fields: [categoryId], references: [id])
  // stableId: 用于前台/ POS / 订单里标识同一菜品的稳定 ID（不可随意更改）
  stableId      String  @unique           
  nameEn        String
  nameZh        String?
  // 新增：菜单图片 & 配料说明（中英文）
  imageUrl      String?
  ingredientsEn String?
  ingredientsZh String?

  basePriceCents Int
  isAvailable    Boolean @default(true)  // 上下架
  isVisible      Boolean @default(true)  // 是否在前台展示（可以与 isAvailable 分开）

  tempUnavailableUntil DateTime?

  sortOrder Int @default(0)

  optionGroups MenuOptionGroup[]
}

model MenuOptionGroup {
  id         String        @id @default(cuid())
  itemId     String
  item       MenuItem      @relation(fields: [itemId], references: [id])

  nameEn     String
  nameZh     String?
  minSelect  Int           @default(0)
  maxSelect  Int           @default(1)
  isRequired Boolean       @default(false)
  isActive   Boolean       @default(true)
  sortOrder  Int           @default(0)

  options    MenuOption[]
}

model MenuOption {
  id               String          @id @default(cuid())
  groupId          String
  group            MenuOptionGroup @relation(fields: [groupId], references: [id])

  nameEn           String
  nameZh           String?
  priceDeltaCents  Int             @default(0)   // 加价（负数也可以做减价）
  isAvailable      Boolean         @default(true)
  tempUnavailableUntil DateTime?
  sortOrder        Int             @default(0)
}
