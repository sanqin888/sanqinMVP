generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// === Enums ===
enum OrderStatus {
  pending
  paid
  making
  ready
  completed
  refunded
}

enum FulfillmentType {
  pickup
  dine_in
  delivery
}

enum Channel {
  web
  in_store
  ubereats
}

enum DeliveryType {
  STANDARD
  PRIORITY
}

enum DeliveryProvider {
  DOORDASH
  UBER
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum LoyaltyEntryType {
  EARN_ON_PURCHASE      // 支付后赚取
  REDEEM_ON_ORDER       // 下单时抵扣
  REFUND_REVERSE_EARN   // 退款时冲回赚取
  REFUND_RETURN_REDEEM  // 退款时退回抵扣

  // ⭐ 新增：用于积分=储值统一记账
  TOPUP_PURCHASED       // 储值/充值时入账的积分（包含本金部分）
  ADJUSTMENT_MANUAL     // 人工调整（活动奖励、补偿、修正等）
}

// === Models ===
model Order {
  id              String          @id @default(uuid()) @db.Uuid
  userId          String?
  clientRequestId String?         @unique
  channel         Channel         @default(web)
  fulfillmentType FulfillmentType @default(pickup)
  status          OrderStatus     @default(pending)
  subtotalCents   Int             @default(0)
  taxCents        Int             @default(0)
  totalCents      Int             @default(0)
  pickupCode      String?

  deliveryType           DeliveryType?
  deliveryProvider       DeliveryProvider?
  deliveryFeeCents       Int?
  deliveryCostCents      Int?
  deliveryEtaMinMinutes  Int?
  deliveryEtaMaxMinutes  Int?
  externalDeliveryId     String?

  createdAt       DateTime        @default(now())

  items OrderItem[]

  @@index([createdAt])
}

model OrderItem {
  id             String @id @default(uuid()) @db.Uuid
  orderId        String @db.Uuid
  productId      String
  qty            Int
  unitPriceCents Int?
  optionsJson    Json?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model LoyaltyAccount {
  id          String      @id @default(uuid()) @db.Uuid
  userId      String      @unique
  pointsMicro BigInt      @db.BigInt
  tier        LoyaltyTier @default(BRONZE)
  createdAt   DateTime    @default(now())

  // ⭐ 新增：累计实际消费（单位：分）
  // 包含：订单实际支付的商品金额（不含积分抵扣） + 储值金额（因为你决定不退款）
  lifetimeSpendCents Int @default(0)

  ledger LoyaltyLedger[]

  @@index([userId])
}

model LoyaltyLedger {
  id                String           @id @default(uuid()) @db.Uuid
  accountId         String           @db.Uuid
  orderId           String?          @db.Uuid
  type              LoyaltyEntryType
  deltaMicro        BigInt           @db.BigInt
  balanceAfterMicro BigInt           @db.BigInt
  note              String?
  createdAt         DateTime         @default(now())

  account LoyaltyAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([orderId, type])
  @@index([accountId, createdAt])
}

model CheckoutIntent {
  id                String   @id @default(uuid()) @db.Uuid
  referenceId       String   @unique
  checkoutSessionId String?  @unique
  amountCents       Int
  currency          String
  locale            String?
  status            String   @default("pending")
  result            String?
  orderId           String?  @db.Uuid
  metadataJson      Json
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([referenceId, createdAt])
}